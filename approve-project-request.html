<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Project Approval System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .project-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .timeline-icon {
            position: absolute;
            left: -23px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .timeline-icon.success {
            background: #198754;
            border-color: #198754;
            color: white;
        }
        
        .timeline-icon.pending {
            background: #ffc107;
            border-color: #ffc107;
            color: white;
        }
        
        .timeline-icon.rejected {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        .detail-view {
            display: none;
        }
        
        .detail-view.active {
            display: block;
        }
        
        .list-view.hidden {
            display: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            color: #212529;
            margin-bottom: 1rem;
        }
        
        .approval-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1.5rem;
            border-top: 2px solid #dee2e6;
            margin: -1rem -1rem 0 -1rem;
        }
        
        .budget-item {
            padding: 0.5rem;
            border-left: 3px solid #198754;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .budget-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .budget-item.selected {
            background: #d1e7dd;
            border-left-color: #0f5132;
        }
        
        .budget-progress {
            height: 6px;
            background: #dee2e6;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        
        .budget-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #198754, #20c997);
            transition: width 0.3s;
        }
        
        .budget-progress-bar.warning {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }
        
        .budget-progress-bar.danger {
            background: linear-gradient(90deg, #dc3545, #c82333);
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-clipboard-check-fill text-primary"></i>
                ระบบอนุมัติโครงการ DGA
            </span>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-hourglass-split"></i>
                    รออนุมัติ: <span id="pending-count">0</span>
                </span>
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i>
                        ผู้ดูแลระบบ
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear"></i> ตั้งค่า</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right"></i> ออกจากระบบ</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <div class="row">
            <!-- Sidebar Filter -->
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-funnel-fill"></i>
                            ตัวกรอง
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">สถานะ</label>
                            <div class="form-check">
                                <input class="form-check-input filter-status" type="checkbox" value="pending" id="filter-pending" checked>
                                <label class="form-check-label" for="filter-pending">
                                    รออนุมัติ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-status" type="checkbox" value="approved" id="filter-approved">
                                <label class="form-check-label" for="filter-approved">
                                    อนุมัติแล้ว
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-status" type="checkbox" value="rejected" id="filter-rejected">
                                <label class="form-check-label" for="filter-rejected">
                                    ไม่อนุมัติ
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">โมเดลการสนับสนุน</label>
                            <select class="form-select form-select-sm" id="filter-support-model">
                                <option value="">ทั้งหมด</option>
                                <option value="full-itc">Full ITC</option>
                                <option value="hybrid-itc-infra">Hybrid (ITC-Infra)</option>
                                <option value="full-vendor">Full Vendor Managed</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">สภาพแวดล้อม</label>
                            <select class="form-select form-select-sm" id="filter-environment">
                                <option value="">ทั้งหมด</option>
                                <option value="dev">Development</option>
                                <option value="staging">Staging</option>
                                <option value="prod">Production</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-outline-secondary btn-sm w-100" id="clear-filters">
                            <i class="bi bi-x-circle"></i>
                            ล้างตัวกรอง
                        </button>
                    </div>
                </div>
                
                <div class="card shadow-sm border-0 mt-3">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-info-circle-fill text-info"></i>
                            สถิติ
                        </h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>รออนุมัติ:</span>
                            <strong class="text-warning" id="stats-pending">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>อนุมัติแล้ว:</span>
                            <strong class="text-success" id="stats-approved">0</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>ไม่อนุมัติ:</span>
                            <strong class="text-danger" id="stats-rejected">0</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Budget Management Card -->
                <div class="card shadow-sm border-0 mt-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-cash-stack text-success"></i>
                                งบประมาณ
                            </h6>
                            <button class="btn btn-sm btn-outline-success" id="btn-add-budget">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                        </div>
                        <div id="budget-list" class="budget-list">
                            <!-- Budget items will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9">
                
                <!-- List View -->
                <div class="list-view">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>
                            <i class="bi bi-list-ul"></i>
                            คำขอทั้งหมด
                        </h4>
                        <div class="input-group" style="max-width: 300px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="search-input" placeholder="ค้นหาโครงการ...">
                        </div>
                    </div>
                    
                    <div id="projects-list">
                        <!-- Projects will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Detail View -->
                <div class="detail-view" id="detail-view">
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary" id="back-to-list">
                            <i class="bi bi-arrow-left"></i>
                            กลับไปรายการ
                        </button>
                    </div>
                    
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <h3 id="detail-project-name">ชื่อโครงการ</h3>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-calendar3"></i>
                                        วันที่ส่งคำขอ: <span id="detail-submit-date">-</span>
                                    </p>
                                </div>
                                <span id="detail-status" class="status-badge status-pending">รออนุมัติ</span>
                            </div>

                            <hr>

                            <!-- Business Information -->
                            <h5 class="mb-3">
                                <i class="bi bi-briefcase-fill text-primary"></i>
                                ข้อมูลโครงการ (Business Approval)
                            </h5>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-label">รหัสโครงการ / Cost Center</div>
                                    <div class="info-value" id="detail-cost-center">-</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-label">Project Manager</div>
                                    <div class="info-value" id="detail-project-manager">-</div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-label">วันที่เริ่มโครงการ</div>
                                    <div class="info-value" id="detail-start-date">-</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-label">วันที่สิ้นสุดโครงการ</div>
                                    <div class="info-value" id="detail-end-date">-</div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="info-label">SLA ที่ต้องการ</div>
                                <div class="info-value" id="detail-sla">-</div>
                            </div>

                            <div class="mb-4">
                                <div class="info-label">ระดับความสำคัญ (Priority)</div>
                                <div class="info-value">
                                    <span class="badge bg-primary" id="detail-priority">-</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="info-label">คำอธิบายโครงการ (Business Objective)</div>
                                <div class="info-value" id="detail-description">-</div>
                            </div>

                            <div class="mb-4">
                                <div class="info-label">สภาพแวดล้อมที่ต้องการ</div>
                                <div id="detail-environments">-</div>
                            </div>

                            <hr>

                            <!-- Technical Information -->
                            <h5 class="mb-3">
                                <i class="bi bi-gear-fill text-primary"></i>
                                ข้อมูลเทคนิค (Technical Approval)
                            </h5>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-label">ข้อมูล Vendor</div>
                                    <div class="info-value" id="detail-vendor">-</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-label">ไฟล์สถาปัตยกรรม</div>
                                    <div class="info-value">
                                        <a href="#" id="detail-architecture-file" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i>
                                            ดาวน์โหลด
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="info-label">คำอธิบายสถาปัตยกรรม</div>
                                <div class="info-value" id="detail-architecture-desc">-</div>
                            </div>

                            <div class="mb-4">
                                <div class="info-label">โมเดลการสนับสนุนที่ร้องขอ</div>
                                <div class="info-value">
                                    <span class="badge bg-info text-dark" id="detail-support-model">-</span>
                                </div>
                            </div>

                            <hr>

                            <!-- Timeline -->
                            <h5 class="mb-3">
                                <i class="bi bi-clock-history text-primary"></i>
                                ประวัติการดำเนินการ
                            </h5>

                            <div class="timeline" id="detail-timeline">
                                <!-- Timeline items will be inserted here -->
                            </div>

                            <!-- Comments Section -->
                            <div class="mt-4" id="comments-section">
                                <h5 class="mb-3">
                                    <i class="bi bi-chat-left-text-fill text-primary"></i>
                                    ความคิดเห็น
                                </h5>
                                <div id="comments-list" class="mb-3">
                                    <!-- Comments will be inserted here -->
                                </div>
                            </div>

                            <!-- Approval Actions (only for pending requests) -->
                            <div class="approval-actions" id="approval-actions" style="display: none;">
                                <h5 class="mb-3">
                                    <i class="bi bi-pencil-square text-primary"></i>
                                    การพิจารณา
                                </h5>
                                
                                <div class="mb-3">
                                    <label for="approval-budget" class="form-label fw-bold">
                                        เลือกงบประมาณ <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="approval-budget" required>
                                        <option value="">-- กรุณาเลือกงบประมาณ --</option>
                                    </select>
                                    <div id="selected-budget-info" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                        <small class="text-muted">
                                            <strong>งบประมาณที่เลือก:</strong> <span id="budget-info-name"></span><br>
                                            <strong>งบคงเหลือ:</strong> <span id="budget-info-remaining"></span>
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="approval-comment" class="form-label fw-bold">ความคิดเห็น / หมายเหตุ</label>
                                    <textarea class="form-control" id="approval-comment" rows="3" placeholder="กรอกความคิดเห็นหรือหมายเหตุเพิ่มเติม..."></textarea>
                                </div>

                                <div class="d-flex gap-2 justify-content-end">
                                    <button class="btn btn-danger" id="btn-reject">
                                        <i class="bi bi-x-circle-fill"></i>
                                        ไม่อนุมัติ
                                    </button>
                                    <button class="btn btn-success" id="btn-approve">
                                        <i class="bi bi-check-circle-fill"></i>
                                        อนุมัติ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Approval Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">ยืนยันการดำเนินการ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    คุณแน่ใจหรือไม่ว่าต้องการดำเนินการนี้?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="confirmAction">ยืนยัน</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Budget Management Modal -->
    <div class="modal fade" id="budgetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="budgetModalTitle">เพิ่มงบประมาณใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="budget-form">
                        <div class="mb-3">
                            <label for="budget-name" class="form-label">ชื่องบประมาณ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="budget-name" required placeholder="เช่น งบประมาณ IT 2567">
                        </div>
                        <div class="mb-3">
                            <label for="budget-year" class="form-label">ปีงบประมาณ <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="budget-year" required placeholder="เช่น 2567" min="2020" max="2100">
                        </div>
                        <div class="mb-3">
                            <label for="budget-amount" class="form-label">จำนวนเงินทั้งหมด (บาท) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="budget-amount" required placeholder="เช่น 5000000" min="0" step="1000">
                        </div>
                        <div class="mb-3">
                            <label for="budget-description" class="form-label">รายละเอียด</label>
                            <textarea class="form-control" id="budget-description" rows="2" placeholder="รายละเอียดเพิ่มเติมของงบประมาณ"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-success" id="save-budget">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Sample data for demonstration
        let budgets = [
            {
                id: 1,
                name: "งบประมาณ IT 2567",
                year: 2567,
                totalAmount: 10000000,
                allocatedAmount: 3000000,
                description: "งบประมาณสำหรับโครงการ IT ประจำปี 2567"
            },
            {
                id: 2,
                name: "งบประมาณพัฒนาระบบ Q1/2567",
                year: 2567,
                totalAmount: 5000000,
                allocatedAmount: 1500000,
                description: "งบประมาณพัฒนาระบบไตรมาสที่ 1"
            },
            {
                id: 3,
                name: "งบประมาณ Digital Transformation",
                year: 2567,
                totalAmount: 15000000,
                allocatedAmount: 12000000,
                description: "งบประมาณสำหรับโครงการ Digital Transformation"
            }
        ];
        
        let projects = [
            {
                id: 1,
                projectName: "ระบบบริการประชาชนออนไลน์",
                costCenter: "CC-2024-001",
                projectManager: "นายสมชาย ใจดี",
                description: "พัฒนาระบบให้บริการประชาชนผ่านช่องทางออนไลน์ เพื่อเพิ่มความสะดวกในการเข้าถึงบริการภาครัฐ",
                startDate: "2024-11-01",
                endDate: "2025-03-31",
                sla: "99.9% uptime, Response time < 2s",
                priority: "public-service",
                priorityLabel: "บริการประชาชน",
                environments: ["dev", "staging", "prod"],
                vendor: "ABC Technology Co., Ltd.",
                architectureFile: "architecture-diagram.pdf",
                architectureDesc: "ใช้ ECS Fargate สำหรับ Application, RDS PostgreSQL สำหรับ Database, S3 สำหรับ Static Files, CloudFront สำหรับ CDN",
                supportModel: "full-itc",
                supportModelLabel: "Full ITC (ITC-Infra & Platform)",
                status: "pending",
                submitDate: "2024-10-15",
                timeline: [
                    { date: "2024-10-15 10:30", action: "ส่งคำขอโครงการ", status: "success", user: "นายสมชาย ใจดี" }
                ],
                comments: []
            },
            {
                id: 2,
                projectName: "ระบบคลังข้อมูลกลาง",
                costCenter: "CC-2024-002",
                projectManager: "นางสาวสมหญิง รักงาน",
                description: "สร้างระบบคลังข้อมูลกลางสำหรับรวบรวมและวิเคราะห์ข้อมูลจากหลายหน่วยงาน",
                startDate: "2024-10-15",
                endDate: "2025-06-30",
                sla: "99.5% uptime, Data sync < 5 minutes",
                priority: "government-service",
                priorityLabel: "บริการหน่วยงานรัฐ",
                environments: ["prod"],
                vendor: "XYZ Solutions Ltd.",
                architectureFile: "data-warehouse-arch.pdf",
                architectureDesc: "ใช้ Redshift สำหรับ Data Warehouse, Glue สำหรับ ETL, Lambda สำหรับ Data Processing",
                supportModel: "hybrid-itc-infra",
                supportModelLabel: "Hybrid (ITC-Infra)",
                status: "approved",
                submitDate: "2024-10-10",
                timeline: [
                    { date: "2024-10-10 09:15", action: "ส่งคำขอโครงการ", status: "success", user: "นางสาวสมหญิง รักงาน" },
                    { date: "2024-10-12 14:20", action: "ผู้ดูแลระบบอนุมัติ", status: "success", user: "Admin User", comment: "โครงการมีความพร้อมและสอดคล้องกับนโยบาย" }
                ],
                comments: [
                    { date: "2024-10-12 14:20", user: "Admin User", text: "โครงการมีความพร้อมและสอดคล้องกับนโยบาย" }
                ]
            },
            {
                id: 3,
                projectName: "แอปพลิเคชันตรวจสอบสถานะ",
                costCenter: "CC-2024-003",
                projectManager: "นายสมศักดิ์ ทำดี",
                description: "พัฒนาแอปพลิเคชันมือถือสำหรับตรวจสอบสถานะการดำเนินงานต่างๆ",
                startDate: "2024-12-01",
                endDate: "2025-05-31",
                sla: "99.0% uptime, Response time < 3s",
                priority: "other",
                priorityLabel: "อื่นๆ",
                environments: ["dev", "staging"],
                vendor: "Mobile Dev Pro",
                architectureFile: "mobile-app-architecture.pdf",
                architectureDesc: "ใช้ API Gateway + Lambda สำหรับ Backend API, DynamoDB สำหรับ Database, Cognito สำหรับ Authentication",
                supportModel: "full-vendor",
                supportModelLabel: "Full Vendor Managed",
                status: "rejected",
                submitDate: "2024-10-08",
                timeline: [
                    { date: "2024-10-08 11:00", action: "ส่งคำขอโครงการ", status: "success", user: "นายสมศักดิ์ ทำดี" },
                    { date: "2024-10-09 16:45", action: "ไม่อนุมัติ", status: "rejected", user: "Admin User", comment: "สถาปัตยกรรมยังไม่สอดคล้องกับมาตรฐานความปลอดภัย กรุณาแก้ไขและส่งใหม่" }
                ],
                comments: [
                    { date: "2024-10-09 16:45", user: "Admin User", text: "สถาปัตยกรรมยังไม่สอดคล้องกับมาตรฐานความปลอดภัย กรุณาแก้ไขและส่งใหม่" }
                ]
            },
            {
                id: 4,
                projectName: "ระบบจัดการเอกสาร",
                costCenter: "CC-2024-004",
                projectManager: "นางสาววิไล เขียนโค้ด",
                description: "พัฒนาระบบจัดการเอกสารอิเล็กทรอนิกส์ พร้อมระบบค้นหาและจัดเก็บ",
                startDate: "2024-11-15",
                endDate: "2025-04-30",
                sla: "99.9% uptime, Search response < 1s",
                priority: "cii",
                priorityLabel: "CII (Critical Information Infrastructure)",
                environments: ["dev", "prod"],
                vendor: "Document Solutions Inc.",
                architectureFile: "dms-architecture.pdf",
                architectureDesc: "ใช้ ECS สำหรับ Application, S3 สำหรับ Document Storage, ElasticSearch สำหรับ Search Engine",
                supportModel: "full-itc",
                supportModelLabel: "Full ITC (ITC-Infra & Platform)",
                status: "pending",
                submitDate: "2024-10-20",
                timeline: [
                    { date: "2024-10-20 08:45", action: "ส่งคำขอโครงการ", status: "success", user: "นางสาววิไล เขียนโค้ด" }
                ],
                comments: []
            }
        ];

        let currentProject = null;
        let filteredProjects = [...projects];
        let currentEditingBudget = null;

        // Initialize
        function init() {
            renderProjectsList();
            updateStats();
            renderBudgetList();
            updateBudgetDropdown();
            setupEventListeners();
        }

        // Render projects list
        function renderProjectsList() {
            const container = document.getElementById('projects-list');
            container.innerHTML = '';

            if (filteredProjects.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        ไม่พบโครงการที่ตรงกับเงื่อนไขการค้นหา
                    </div>
                `;
                return;
            }

            filteredProjects.forEach(project => {
                const card = createProjectCard(project);
                container.appendChild(card);
            });
        }

        // Create project card element
        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'card shadow-sm border-0 mb-3 project-card';
            
            const statusClass = project.status === 'pending' ? 'status-pending' : 
                              project.status === 'approved' ? 'status-approved' : 'status-rejected';
            const statusText = project.status === 'pending' ? 'รออนุมัติ' : 
                             project.status === 'approved' ? 'อนุมัติแล้ว' : 'ไม่อนุมัติ';
            
            const envBadges = project.environments.map(env => {
                const envLabel = env === 'dev' ? 'Dev' : env === 'staging' ? 'Staging' : 'Prod';
                return `<span class="badge bg-secondary me-1">${envLabel}</span>`;
            }).join('');

            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">${project.projectName}</h5>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <p class="text-muted mb-2">
                        <i class="bi bi-hash"></i> ${project.costCenter}
                        <span class="mx-2">|</span>
                        <i class="bi bi-person"></i> ${project.projectManager}
                    </p>
                    <p class="card-text text-truncate mb-2">${project.description}</p>
                    <div class="mb-2">
                        ${envBadges}
                        <span class="badge bg-info text-dark">${project.supportModelLabel}</span>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-calendar3"></i>
                        ${project.submitDate}
                    </small>
                </div>
            `;

            card.addEventListener('click', () => showProjectDetail(project));
            return card;
        }

        // Show project detail
        function showProjectDetail(project) {
            currentProject = project;
            
            // Update detail view
            document.getElementById('detail-project-name').textContent = project.projectName;
            document.getElementById('detail-submit-date').textContent = project.submitDate;
            document.getElementById('detail-cost-center').textContent = project.costCenter;
            document.getElementById('detail-project-manager').textContent = project.projectManager;
            document.getElementById('detail-start-date').textContent = project.startDate || 'ไม่ระบุ';
            document.getElementById('detail-end-date').textContent = project.endDate || 'ไม่ระบุ';
            document.getElementById('detail-sla').textContent = project.sla || 'ไม่ระบุ';
            document.getElementById('detail-priority').textContent = project.priorityLabel || 'ไม่ระบุ';
            document.getElementById('detail-description').textContent = project.description;
            document.getElementById('detail-vendor').textContent = project.vendor || 'ไม่ระบุ';
            document.getElementById('detail-architecture-desc').textContent = project.architectureDesc || 'ไม่มีรายละเอียด';
            document.getElementById('detail-support-model').textContent = project.supportModelLabel;

            // Update status badge
            const statusBadge = document.getElementById('detail-status');
            statusBadge.className = 'status-badge';
            if (project.status === 'pending') {
                statusBadge.classList.add('status-pending');
                statusBadge.textContent = 'รออนุมัติ';
            } else if (project.status === 'approved') {
                statusBadge.classList.add('status-approved');
                statusBadge.textContent = 'อนุมัติแล้ว';
            } else {
                statusBadge.classList.add('status-rejected');
                statusBadge.textContent = 'ไม่อนุมัติ';
            }

            // Update environments
            const envContainer = document.getElementById('detail-environments');
            envContainer.innerHTML = project.environments.map(env => {
                const envLabel = env === 'dev' ? 'Development' : env === 'staging' ? 'Staging' : 'Production';
                return `<span class="badge bg-secondary me-1">${envLabel}</span>`;
            }).join('');

            // Update timeline
            const timelineContainer = document.getElementById('detail-timeline');
            timelineContainer.innerHTML = project.timeline.map(item => {
                const iconClass = item.status === 'success' ? 'success' : 
                                item.status === 'pending' ? 'pending' : 'rejected';
                const icon = item.status === 'success' ? '✓' : 
                           item.status === 'pending' ? '⋯' : '✕';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-icon ${iconClass}">${icon}</div>
                        <div>
                            <strong>${item.action}</strong>
                            <div class="text-muted small">
                                ${item.user} - ${item.date}
                            </div>
                            ${item.comment ? `<div class="mt-1">${item.comment}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Update comments
            const commentsContainer = document.getElementById('comments-list');
            if (project.comments.length === 0) {
                commentsContainer.innerHTML = '<p class="text-muted">ยังไม่มีความคิดเห็น</p>';
            } else {
                commentsContainer.innerHTML = project.comments.map(comment => `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between">
                                <strong>${comment.user}</strong>
                                <small class="text-muted">${comment.date}</small>
                            </div>
                            <p class="mb-0 mt-1">${comment.text}</p>
                        </div>
                    </div>
                `).join('');
            }

            // Show/hide approval actions
            const approvalActions = document.getElementById('approval-actions');
            if (project.status === 'pending') {
                approvalActions.style.display = 'block';
            } else {
                approvalActions.style.display = 'none';
            }

            // Switch views
            document.querySelector('.list-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('active');
        }

        // Back to list
        function backToList() {
            document.querySelector('.list-view').classList.remove('hidden');
            document.getElementById('detail-view').classList.remove('active');
            currentProject = null;
            document.getElementById('approval-comment').value = '';
            document.getElementById('approval-budget').value = '';
            document.getElementById('selected-budget-info').style.display = 'none';
        }

        // Update statistics
        function updateStats() {
            const pending = projects.filter(p => p.status === 'pending').length;
            const approved = projects.filter(p => p.status === 'approved').length;
            const rejected = projects.filter(p => p.status === 'rejected').length;

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('stats-pending').textContent = pending;
            document.getElementById('stats-approved').textContent = approved;
            document.getElementById('stats-rejected').textContent = rejected;
        }

        // Filter projects
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilters = Array.from(document.querySelectorAll('.filter-status:checked')).map(cb => cb.value);
            const supportModelFilter = document.getElementById('filter-support-model').value;
            const environmentFilter = document.getElementById('filter-environment').value;

            filteredProjects = projects.filter(project => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    project.projectName.toLowerCase().includes(searchTerm) ||
                    project.costCenter.toLowerCase().includes(searchTerm) ||
                    project.projectManager.toLowerCase().includes(searchTerm);

                // Status filter
                const matchesStatus = statusFilters.length === 0 || statusFilters.includes(project.status);

                // Support model filter
                const matchesSupportModel = !supportModelFilter || project.supportModel === supportModelFilter;

                // Environment filter
                const matchesEnvironment = !environmentFilter || project.environments.includes(environmentFilter);

                return matchesSearch && matchesStatus && matchesSupportModel && matchesEnvironment;
            });

            renderProjectsList();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.querySelectorAll('.filter-status').forEach(cb => {
                cb.checked = cb.value === 'pending';
            });
            document.getElementById('filter-support-model').value = '';
            document.getElementById('filter-environment').value = '';
            applyFilters();
        }

        // Approve project
        function approveProject() {
            const comment = document.getElementById('approval-comment').value.trim();
            const selectedBudgetId = parseInt(document.getElementById('approval-budget').value);
            
            if (!selectedBudgetId) {
                alert('กรุณาเลือกงบประมาณก่อนอนุมัติ');
                return;
            }
            
            const selectedBudget = budgets.find(b => b.id === selectedBudgetId);
            if (!selectedBudget) {
                alert('ไม่พบงบประมาณที่เลือก');
                return;
            }
            
            // Simple budget amount check (in real system, project would have a cost)
            const projectEstimatedCost = 500000; // Mock value
            const remainingBudget = selectedBudget.totalAmount - selectedBudget.allocatedAmount;
            
            if (projectEstimatedCost > remainingBudget) {
                alert(`งบประมาณคงเหลือไม่เพียงพอ\nต้องการ: ${formatNumber(projectEstimatedCost)} บาท\nคงเหลือ: ${formatNumber(remainingBudget)} บาท`);
                return;
            }
            
            if (confirm(`คุณต้องการอนุมัติโครงการ "${currentProject.projectName}" ใช่หรือไม่?\n\nใช้งบประมาณ: ${selectedBudget.name}\nจำนวนเงินโครงการ: ${formatNumber(projectEstimatedCost)} บาท`)) {
                // Update budget allocation
                selectedBudget.allocatedAmount += projectEstimatedCost;
                
                // Update project status
                currentProject.status = 'approved';
                currentProject.budgetId = selectedBudgetId;
                currentProject.budgetName = selectedBudget.name;
                currentProject.allocatedAmount = projectEstimatedCost;
                currentProject.timeline.push({
                    date: new Date().toLocaleString('th-TH'),
                    action: 'ผู้ดูแลระบบอนุมัติ',
                    status: 'success',
                    user: 'Admin User',
                    comment: comment || `อนุมัติโครงการ (งบประมาณ: ${selectedBudget.name})`
                });
                
                if (comment) {
                    currentProject.comments.push({
                        date: new Date().toLocaleString('th-TH'),
                        user: 'Admin User',
                        text: comment
                    });
                }

                updateStats();
                renderBudgetList();
                updateBudgetDropdown();
                backToList();
                applyFilters();
                
                // Show success message
                showSuccessToast('อนุมัติโครงการสำเร็จ');
            }
        }

        // Reject project
        function rejectProject() {
            const comment = document.getElementById('approval-comment').value.trim();
            
            if (!comment) {
                alert('กรุณาระบุเหตุผลในการไม่อนุมัติ');
                return;
            }
            
            if (confirm(`คุณต้องการไม่อนุมัติโครงการ "${currentProject.projectName}" ใช่หรือไม่?`)) {
                // Update project status
                currentProject.status = 'rejected';
                currentProject.timeline.push({
                    date: new Date().toLocaleString('th-TH'),
                    action: 'ไม่อนุมัติ',
                    status: 'rejected',
                    user: 'Admin User',
                    comment: comment
                });
                
                currentProject.comments.push({
                    date: new Date().toLocaleString('th-TH'),
                    user: 'Admin User',
                    text: comment
                });

                updateStats();
                backToList();
                applyFilters();
                
                // Show success message
                showSuccessToast('บันทึกการไม่อนุมัติเรียบร้อย');
            }
        }

        // Show success toast
        function showSuccessToast(message) {
            // Simple alert for now - could be replaced with toast notification
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Budget Management Functions
        
        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Render budget list in sidebar
        function renderBudgetList() {
            const container = document.getElementById('budget-list');
            
            if (budgets.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">ยังไม่มีงบประมาณ</p>';
                return;
            }
            
            container.innerHTML = budgets.map(budget => {
                const remaining = budget.totalAmount - budget.allocatedAmount;
                const percentUsed = (budget.allocatedAmount / budget.totalAmount * 100).toFixed(1);
                const progressClass = percentUsed > 90 ? 'danger' : percentUsed > 70 ? 'warning' : '';
                
                return `
                    <div class="budget-item" data-budget-id="${budget.id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-bold small">${budget.name}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    คงเหลือ: ${formatNumber(remaining)} / ${formatNumber(budget.totalAmount)} บาท
                                </div>
                                <div class="budget-progress">
                                    <div class="budget-progress-bar ${progressClass}" style="width: ${percentUsed}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update budget dropdown in approval section
        function updateBudgetDropdown() {
            const select = document.getElementById('approval-budget');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- กรุณาเลือกงบประมาณ --</option>';
            
            budgets.forEach(budget => {
                const remaining = budget.totalAmount - budget.allocatedAmount;
                const option = document.createElement('option');
                option.value = budget.id;
                option.textContent = `${budget.name} (คงเหลือ: ${formatNumber(remaining)} บาท)`;
                if (remaining <= 0) {
                    option.disabled = true;
                    option.textContent += ' - งบหมด';
                }
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // Show budget selection info
        function showBudgetInfo(budgetId) {
            const budget = budgets.find(b => b.id === budgetId);
            if (!budget) {
                document.getElementById('selected-budget-info').style.display = 'none';
                return;
            }
            
            const remaining = budget.totalAmount - budget.allocatedAmount;
            document.getElementById('budget-info-name').textContent = budget.name;
            document.getElementById('budget-info-remaining').textContent = formatNumber(remaining) + ' บาท';
            document.getElementById('selected-budget-info').style.display = 'block';
        }
        
        // Open budget modal for adding new budget
        function openBudgetModal() {
            currentEditingBudget = null;
            document.getElementById('budgetModalTitle').textContent = 'เพิ่มงบประมาณใหม่';
            document.getElementById('budget-form').reset();
            document.getElementById('budget-year').value = new Date().getFullYear() + 543; // Thai year
            
            // Show modal using vanilla JS
            const modalElement = document.getElementById('budgetModal');
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.setAttribute('aria-hidden', 'false');
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'modal-backdrop';
            document.body.appendChild(backdrop);
            document.body.classList.add('modal-open');
        }
        
        // Close budget modal
        function closeBudgetModal() {
            const modalElement = document.getElementById('budgetModal');
            modalElement.style.display = 'none';
            modalElement.classList.remove('show');
            modalElement.setAttribute('aria-hidden', 'true');
            
            // Remove backdrop
            const backdrop = document.getElementById('modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            document.body.classList.remove('modal-open');
        }
        
        // Save budget
        function saveBudget() {
            const name = document.getElementById('budget-name').value.trim();
            const year = parseInt(document.getElementById('budget-year').value);
            const amount = parseFloat(document.getElementById('budget-amount').value);
            const description = document.getElementById('budget-description').value.trim();
            
            if (!name || !year || !amount) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            if (amount <= 0) {
                alert('จำนวนเงินต้องมากกว่า 0');
                return;
            }
            
            if (currentEditingBudget) {
                // Edit existing budget
                currentEditingBudget.name = name;
                currentEditingBudget.year = year;
                currentEditingBudget.totalAmount = amount;
                currentEditingBudget.description = description;
            } else {
                // Add new budget
                const newBudget = {
                    id: budgets.length > 0 ? Math.max(...budgets.map(b => b.id)) + 1 : 1,
                    name: name,
                    year: year,
                    totalAmount: amount,
                    allocatedAmount: 0,
                    description: description
                };
                budgets.push(newBudget);
            }
            
            renderBudgetList();
            updateBudgetDropdown();
            closeBudgetModal();
            showSuccessToast('บันทึกงบประมาณสำเร็จ');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Back to list button
            document.getElementById('back-to-list').addEventListener('click', backToList);

            // Approval buttons
            document.getElementById('btn-approve').addEventListener('click', approveProject);
            document.getElementById('btn-reject').addEventListener('click', rejectProject);

            // Filter controls
            document.getElementById('search-input').addEventListener('input', applyFilters);
            document.querySelectorAll('.filter-status').forEach(cb => {
                cb.addEventListener('change', applyFilters);
            });
            document.getElementById('filter-support-model').addEventListener('change', applyFilters);
            document.getElementById('filter-environment').addEventListener('change', applyFilters);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            
            // Budget management
            document.getElementById('btn-add-budget').addEventListener('click', openBudgetModal);
            document.getElementById('save-budget').addEventListener('click', saveBudget);
            
            // Budget modal close buttons
            document.querySelectorAll('#budgetModal .btn-close, #budgetModal .btn-secondary').forEach(btn => {
                btn.addEventListener('click', closeBudgetModal);
            });
            
            // Budget selection change
            document.getElementById('approval-budget').addEventListener('change', function() {
                const budgetId = parseInt(this.value);
                if (budgetId) {
                    showBudgetInfo(budgetId);
                } else {
                    document.getElementById('selected-budget-info').style.display = 'none';
                }
            });
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
